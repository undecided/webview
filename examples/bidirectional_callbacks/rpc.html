<html>
  <head>
  </head>

  <body onload='onpageload()'>
    <h3>Current directory: <code id='current_directory_name'>(loading!...)</code></h3>
    <button data-rpc='change_directory'>../</button>
    <br />
    <div id='directory_contents'></div>

    <br />
    <br />
    <hr />
    <div id='debugging'></div>

    <script type='text/javascript'>
      function onpageload() {
        function listing() { return document.querySelector('#directory_contents') }
        function current_label() { return document.querySelector('#current_directory_name') }
        function debugging_div() { return document.querySelector('#debugging') }

        window.rpc_cb = function(type, value, userdata) {
          err('RPC callback "' + type + '", "' + JSON.stringify(value) + '", "' + JSON.stringify(userdata) + '"')
          if(type != 'change_directory') {
            change_directory_successful(userdata, value)
          }
        }

        function err(txt) {
          debugging_div().innerHTML = debugging_div().innerHTML + "<br />" + '<code style="color: red">' + txt + '</code>'
        }

        function info(txt) {
          debugging_div().innerHTML = debugging_div().innerHTML + "<br />" + '<code style="color: blue">' + txt + '</code>'
        }

        info('loaded')

        function change_directory_successful(userdata, value) {
          var directory_output = "";
          for(var i; i < value.child_directories.length ; i++) {
            directory_output += '<button data-rpc="change_directory">'+ value.child_directories[i] +'</button>';
          }

          directory_output += '<br /><ul>'
          for(var i; i < value.child_files.length ; i++) {
            directory_output += '<li>'+ value.child_files[i] +'</li>';
          }
          directory_output += '</ul>';
          listing().innerHTML = directory_output;
        }

        var invoke_with_logging = function(data) {
          info("invoke data: \"" + data + '"');
          window.external.invoke(data);
        }

        var elems = document.querySelectorAll('button[data-rpc]');
        for (var i = 0; i < elems.length; i++) {
          var elem = elems[i];
          elem.onclick = function(e) {
            info('button clicked')
            var action = e.target.dataset.rpc;
            var userdata = new Date().getTime().toString();
            var data = action + ',' + userdata
            invoke_with_logging(data)
          }
        }
      }
    </script>
  </body>
</html>
